<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airdrop Contract UI</title>
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        header {
            text-align: center;
            padding: 20px;
            background-color: #007bff;
            color: white;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
            position: relative;
        }
        header .wallet-status {
            margin-top: 10px;
        }
        header button {
            padding: 12px 24px;
            background-color: #28a745;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 10px;
            font-size: 16px;
            transition: background-color 0.3s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        header button:hover {
            background-color: #218838;
        }
        nav {
            margin: 20px 0;
            text-align: center;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
        }
        nav button {
            margin: 0 10px;
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 10px;
            font-size: 16px;
            transition: background-color 0.3s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        nav button:hover {
            background-color: #0056b3;
        }
        .section {
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: none;
        }
        .section.active {
            display: block;
        }
        .section h2 {
            color: #007bff;
            margin-bottom: 15px;
        }
        .section h3, .section h4 {
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        input, button {
            padding: 12px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 10px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #0056b3;
        }
        .recipient-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .recipient-row input {
            flex: 1;
            margin-right: 10px;
        }
        #tx-status, #error-message {
            margin-top: 15px;
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }
        #error-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .wallet-instructions {
            margin: 10px 0;
            padding: 12px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            text-align: left;
            font-size: 14px;
        }
        .wallet-connected {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }
        .log-tabs {
            display: flex;
            margin-top: 20px;
            background-color: #e9ecef;
            border-radius: 5px 5px 0 0;
        }
        .log-tab {
            padding: 12px 24px;
            background-color: #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .log-tab.active {
            background-color: #007bff;
            color: white;
        }
        .log-tab:hover {
            background-color: #ccc;
        }
        .log-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0 5px 5px 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-table th, .log-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .log-table th {
            background-color: #f2f2f2;
        }
        .event-success {
            background-color: #d4edda;
            color: #155724;
        }
        .event-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .contract-info-card {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 600px) {
            .recipient-row {
                flex-direction: column;
            }
            input, button {
                width: 100%;
            }
            nav button, .log-tab {
                margin: 5px 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Airdrop Contract UI (Polygon Amoy)</h1>
            <div class="wallet-status" id="wallet-status">
                <button id="connect-wallet">Connect Wallet</button>
                <div id="wallet-info" style="display: none;">
                    <p id="connected-address" class="wallet-connected"></p>
                    <button id="disconnect-wallet">Disconnect</button>
                </div>
                <div id="wallet-instructions" class="wallet-instructions" style="display: none;"></div>
            </div>
            <div style="position: absolute; top: 10px; right: 10px;">
                <input type="text" id="general-search" placeholder="Search transactions">
            </div>
        </header>
        <nav>
            <button onclick="showSection('home')">Home</button>
            <button onclick="showSection('owner')" style="display: none;">Owner's Panel</button>
            <button onclick="showSection('user')" style="display: none;">User's Panel</button>
            <button onclick="showSection('transaction-history')">Transaction History</button>
        </nav>
        <div id="home" class="section active">
            <h2>Airdrop Contract Information</h2>
            <p>Contract Address: <span id="hardcoded-address">Not Connected</span></p>
            <div id="contract-info" class="contract-info-card"></div>
            <div id="error-message"></div>
        </div>
        <div id="owner" class="section">
            <h2>Owner's Panel</h2>
            <div id="airdrop-management">
                <h3>Airdrop Management</h3>
                <h4>Manual Input</h4>
                <div id="recipients">
                    <div class="recipient-row">
                        <input type="text" placeholder="Address">
                        <input type="number" placeholder="Amount (Tokens, e.g., 1 for 1 token)" step="0.1">
                        <button onclick="removeRecipient(this)">Remove</button>
                    </div>
                </div>
                <button onclick="addRecipient()">Add Recipient</button>
                <button id="remove-csv" onclick="clearRecipients()" style="display: none;">Remove CSV</button>
                <p>Total: <span id="total-amount">0</span> Tokens</p>
                <button onclick="performAirdrop()">Perform Airdrop</button>
                <h4>Batch Input (Comma-Separated)</h4>
                <input type="text" id="batch-input" placeholder="Address1,Amount1,Address2,Amount2,...">
                <button onclick="performBatchAirdrop()">Airdrop from Batch</button>
                <h4>CSV Upload</h4>
                <input type="file" id="csv-upload" accept=".csv" onchange="processCSV(this.files[0])">
                <button onclick="performCSVAirdrop()">Airdrop from CSV</button>
            </div>
            <div class="pause-unpause">
                <h3>Contract Status</h3>
                <p>Status: <span id="contract-status">Unknown</span></p>
                <button onclick="togglePause()">Toggle Pause</button>
            </div>
            <div class="withdraw">
                <h3>Withdraw Tokens</h3>
                <input type="number" id="withdraw-amount" placeholder="Amount (Tokens, e.g., 1 for 1 token)" step="0.1">
                <button onclick="withdrawTokens()">Withdraw</button>
            </div>
            <div id="tx-status"></div>
            <div id="error-message" class="error"></div>
        </div>
        <div id="user" class="section">
            <h2>User's Panel</h2>
            <input type="text" id="check-address" placeholder="Enter address (leave blank for connected wallet)">
            <button onclick="checkBalance()">Check Balance</button>
            <div id="balance-result"></div>
            <h3>Transfer Tokens</h3>
            <input type="text" id="transfer-to" placeholder="Recipient Address">
            <input type="number" id="transfer-amount" placeholder="Amount (Tokens, e.g., 1 for 1 token)" step="0.1">
            <button onclick="transferTokens()">Transfer</button>
            <div id="error-message" class="error"></div>
        </div>
        <div id="transaction-history" class="section">
            <h2>Transaction History</h2>
            <input type="text" id="search-input" placeholder="Search by name, address, tx hash, amount, block number">
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Event</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="transaction-history-body"></tbody>
            </table>
        </div>
        <div class="log-tabs">
            <div class="log-tab active" onclick="showLogTab('admin-logs')">Admin Logs</div>
            <div class="log-tab" onclick="showLogTab('user-logs')">User Logs</div>
        </div>
        <div id="admin-logs" class="log-content active">
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="admin-log-body"></tbody>
            </table>
        </div>
        <div id="user-logs" class="log-content">
            <table class="log-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Event</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="user-log-body"></tbody>
            </table>
        </div>
    </div>
    <script src="https://unpkg.com/web3@1.10.4/dist/web3.min.js"></script>
    <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script>
        // Hardcoded constants
        const CONTRACT_ADDRESS = "0x71d8cc90b62ee78c3a9374e9a8f0ec46e34e22e5";
        const TOKEN_ADDRESS = "0x9a15aca3b949b057ff7c99df82675a4e3f4b553d";
        const OWNER_ADDRESS = '0x632AAd3786450406a7b18F0B5F3B121cC59Fee87';

        // Web3Modal setup
        const providerOptions = {
            walletconnect: {
                package: WalletConnectProvider,
                options: {
                    rpc: { 80002: "https://rpc-amoy.polygon.technology/" },
                    chainId: 80002
                }
            }
        };
        const web3Modal = new Web3Modal({
            cacheProvider: false,
            providerOptions
        });

        // Logging functions
        function saveLog(type, event, details, isSuccess = true) {
            const logs = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const newLog = {
                type,
                time: new Date().toISOString(),
                event,
                details,
                isSuccess
            };
            logs.push(newLog);
            localStorage.setItem('transactionHistory', JSON.stringify(logs));
        }

        function logAdmin(event, details, isSuccess = true) {
            saveLog('admin', event, details, isSuccess);
            const logBody = document.getElementById('admin-log-body');
            const row = document.createElement('tr');
            row.className = isSuccess ? 'event-success' : 'event-error';
            row.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>${event}</td><td>${details}</td>`;
            logBody.insertBefore(row, logBody.firstChild);
        }

        function logUser(event, details, isSuccess = true) {
            saveLog('user', event, details, isSuccess);
            const logBody = document.getElementById('user-log-body');
            const row = document.createElement('tr');
            row.className = isSuccess ? 'event-success' : 'event-error';
            row.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>${event}</td><td>${details}</td>`;
            logBody.insertBefore(row, logBody.firstChild);
        }

        function showLogTab(tabId) {
            document.querySelectorAll('.log-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.log-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`.log-tab[onclick="showLogTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function showError(section, message) {
            const errorDiv = document.querySelector(`#${section} #error-message`);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.add('error');
                setTimeout(() => errorDiv.classList.remove('error'), 5000);
            }
            if (section === 'owner' || section === 'home') {
                logAdmin('Error', message, false);
            } else {
                logUser('Error', message, false);
            }
        }

        // Transaction history
        function loadTransactionHistory() {
            const logs = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const tableBody = document.getElementById('transaction-history-body');
            tableBody.innerHTML = '';
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.className = log.isSuccess ? 'event-success' : 'event-error';
                const detailsHtml = log.details.replace(/(Tx: )([0x[a-fA-F0-9]{64}])/g, '$1<a href="https://amoy.polygonscan.com/tx/$2" target="_blank">$2</a>');
                row.innerHTML = `
                    <td>${new Date(log.time).toLocaleString()}</td>
                    <td>${log.type}</td>
                    <td>${log.event}</td>
                    <td>${detailsHtml}</td>
                `;
                tableBody.appendChild(row);
            });
            document.getElementById('search-input').value = '';
        }

        // ABIs (unchanged)
        const AirdropABI = [/* ... unchanged ... */];
        const ERC20ABI = [/* ... unchanged ... */];

        let web3, contract, tokenContract, userAddress, contractBalance = '0', isPaused = false, tokenSymbol = '', decimals = 18, provider;

        // Wallet connection
        document.getElementById('connect-wallet').addEventListener('click', async () => {
            try {
                provider = await web3Modal.connect();
                web3 = new Web3(provider);
                const accounts = await web3.eth.getAccounts();
                userAddress = accounts[0];

                const chainId = await web3.eth.getChainId();
                if (chainId !== 80002) {
                    try {
                        await provider.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x13882' }]
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await provider.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x13882',
                                    chainName: 'Polygon Amoy',
                                    rpcUrls: ['https://rpc-amoy.polygon.technology/'],
                                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                    blockExplorerUrls: ['https://amoy.polygonscan.com/']
                                }]
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }

                contract = new web3.eth.Contract(AirdropABI, CONTRACT_ADDRESS);
                tokenContract = new web3.eth.Contract(ERC20ABI, TOKEN_ADDRESS);

                const [name, symbol, balance, total, paused, tokenDecimals] = await Promise.all([
                    tokenContract.methods.name().call(),
                    tokenContract.methods.symbol().call(),
                    contract.methods.getBalance().call(),
                    contract.methods.totalDistributed().call(),
                    contract.methods.paused().call(),
                    tokenContract.methods.decimals().call()
                ]);

                decimals = parseInt(tokenDecimals);
                contractBalance = (parseInt(balance) / 10 ** decimals).toFixed(2);
                isPaused = paused;
                tokenSymbol = symbol;

                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('connected-address').innerHTML = `Connected Address: ${userAddress}<br>Connected`;
                document.getElementById('connect-wallet').style.display = 'none';
                document.getElementById('disconnect-wallet').style.display = 'inline-block';
                document.getElementById('hardcoded-address').textContent = CONTRACT_ADDRESS;
                document.getElementById('contract-info').innerHTML = `
                    <p>Token Name: ${name}</p>
                    <p>Token Symbol: ${symbol}</p>
                    <p>Contract Balance: ${contractBalance} ${symbol}</p>
                    <p>Total Distributed: ${(parseInt(total) / 10 ** decimals).toFixed(2)} ${symbol}</p>
                    <p>Contract Status: ${paused ? 'Paused' : 'Unpaused'}</p>
                `;
                document.getElementById('contract-status').textContent = paused ? 'Paused' : 'Unpaused';

                if (userAddress.toLowerCase() === OWNER_ADDRESS.toLowerCase()) {
                    document.querySelector('button[onclick="showSection(\'owner\')"]').style.display = 'inline-block';
                    document.querySelector('button[onclick="showSection(\'user\')"]').style.display = 'none';
                } else {
                    document.querySelector('button[onclick="showSection(\'owner\')"]').style.display = 'none';
                    document.querySelector('button[onclick="showSection(\'user\')"]').style.display = 'inline-block';
                }

                contract.events.Success({ fromBlock: 'latest' })
                    .on('data', (event) => {
                        const totalAmount = event.returnValues.amounts.reduce((sum, val) => sum + parseInt(val), 0) / 10 ** decimals;
                        logAdmin('Airdrop Success', `${event.returnValues.hunters.length} recipients, Total: ${totalAmount} ${tokenSymbol}`);
                    });
                contract.events.Paused({ fromBlock: 'latest' })
                    .on('data', (event) => logAdmin('Contract Paused', `By ${event.returnValues.account}`));
                contract.events.Unpaused({ fromBlock: 'latest' })
                    .on('data', (event) => logAdmin('Contract Unpaused', `By ${event.returnValues.account}`));
                contract.events.Withdrawn({ fromBlock: 'latest' })
                    .on('data', (event) => logAdmin('Withdraw', `${(parseInt(event.returnValues.amount) / 10 ** decimals).toFixed(2)} ${tokenSymbol} by ${event.returnValues.owner}`));

                tokenContract.events.Transfer({ filter: { from: CONTRACT_ADDRESS }, fromBlock: 'latest' })
                    .on('data', (event) => {
                        logAdmin('Airdrop Distribution', `To ${event.returnValues.to}, Amount: ${(parseInt(event.returnValues.value) / 10 ** decimals).toFixed(2)} ${tokenSymbol}, Tx: ${event.transactionHash}`);
                    })
                    .on('error', (error) => logAdmin('Airdrop Distribution Error', error.message, false));

                tokenContract.events.Transfer({ filter: { from: OWNER_ADDRESS }, fromBlock: 'latest' })
                    .on('data', (event) => {
                        logAdmin('Owner Transfer', `To ${event.returnValues.to}, Amount: ${(parseInt(event.returnValues.value) / 10 ** decimals).toFixed(2)} ${tokenSymbol}, Tx: ${event.transactionHash}`);
                    })
                    .on('error', (error) => logAdmin('Owner Transfer Error', error.message, false));

                if (userAddress.toLowerCase() !== OWNER_ADDRESS.toLowerCase()) {
                    tokenContract.events.Transfer({ filter: { from: userAddress }, fromBlock: 'latest' })
                        .on('data', (event) => {
                            logUser('Transfer', `To ${event.returnValues.to}, Amount: ${(parseInt(event.returnValues.value) / 10 ** decimals).toFixed(2)} ${tokenSymbol}, Tx: ${event.transactionHash}`);
                        })
                        .on('error', (error) => logUser('Transfer Error', error.message, false));
                }

                logAdmin('Wallet Connected', `Connected to ${userAddress}`);
            } catch (error) {
                logAdmin('Connection Error', error.message, false);
                showError('home', "Failed to connect wallet: " + error.message);
                showWalletInstructions();
            }
        });

        document.getElementById('disconnect-wallet').addEventListener('click', async () => {
            if (provider && typeof provider.disconnect === 'function') {
                await provider.disconnect();
            }
            userAddress = null;
            contract = null;
            tokenContract = null;
            provider = null;
            document.getElementById('wallet-info').style.display = 'none';
            document.getElementById('connect-wallet').style.display = 'inline-block';
            document.getElementById('disconnect-wallet').style.display = 'none';
            document.getElementById('hardcoded-address').textContent = 'Not Connected';
            document.getElementById('contract-info').innerHTML = '';
            document.getElementById('contract-status').textContent = 'Unknown';
            document.getElementById('tx-status').textContent = '';
            document.getElementById('balance-result').innerHTML = '';
            document.getElementById('admin-log-body').innerHTML = '';
            document.getElementById('user-log-body').innerHTML = '';
            document.querySelector('button[onclick="showSection(\'owner\')"]').style.display = 'none';
            document.querySelector('button[onclick="showSection(\'user\')"]').style.display = 'none';
            logAdmin('Wallet Disconnected', 'Disconnected successfully');
        });

        function showWalletInstructions() {
            const instructions = document.getElementById('wallet-instructions');
            instructions.style.display = 'block';
            instructions.innerHTML = `<strong>Wallet Not Detected</strong><br>Please install MetaMask from <a href="https://metamask.io" target="_blank">metamask.io</a> to interact with this DApp.`;
        }

        // Section navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'transaction-history') {
                loadTransactionHistory();
            }
            logAdmin('Section Changed', `Switched to ${sectionId}`);
        }

        // General search bar
        document.getElementById('general-search').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            showSection('transaction-history');
            const rows = document.querySelectorAll('#transaction-history-body tr');
            rows.forEach(row => {
                const details = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                row.style.display = details.includes(searchTerm) ? '' : 'none';
            });
        });

        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#transaction-history-body tr');
            rows.forEach(row => {
                const details = row.querySelector('td:nth-child(4)').textContent.toLowerCase();
                row.style.display = details.includes(searchTerm) ? '' : 'none';
            });
        });

        // Helper function to convert tokens to wei-like units safely
        function toWeiLike(amount, decimals) {
            const [integerPart, fractionalPart = ''] = amount.toString().split('.');
            const paddedFraction = fractionalPart.padEnd(decimals, '0').slice(0, decimals);
            return web3.utils.toBN(integerPart + paddedFraction);
        }

        // Airdrop management (unchanged functions)
        function addRecipient() { /* ... unchanged ... */ }
        function removeRecipient(button) { /* ... unchanged ... */ }
        function clearRecipients() { /* ... unchanged ... */ }
        function updateTotal() { /* ... unchanged ... */ }
        async function performAirdrop() { /* ... unchanged ... */ }
        async function processCSV(file) { /* ... unchanged ... */ }
        async function performCSVAirdrop() { /* ... unchanged ... */ }
        async function performBatchAirdrop() { /* ... unchanged ... */ }
        async function togglePause() { /* ... unchanged ... */ }
        async function withdrawTokens() { /* ... unchanged ... */ }
        async function checkBalance() { /* ... unchanged ... */ }
        async function transferTokens() { /* ... unchanged ... */ }
        async function updateContractInfo() { /* ... unchanged ... */ }

        // Initial log
        logAdmin('Page Loaded', 'DApp initialized');
    </script>
</body>
</html>
