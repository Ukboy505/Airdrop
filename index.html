<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airdrop Dapp</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 20px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
        }
        header button {
            padding: 10px 20px;
            background-color: #28a745;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }
        nav {
            margin: 20px 0;
            text-align: center;
        }
        nav button {
            margin: 0 10px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        nav button:hover {
            background-color: #0056b3;
        }
        .section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        .section.active {
            display: block;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .recipient-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .recipient-row input {
            flex: 1;
            margin-right: 10px;
        }
        #tx-status, #debug {
            margin-top: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        #debug {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .wallet-instructions {
            margin: 10px 0;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            text-align: left;
        }
        @media (max-width: 600px) {
            .recipient-row {
                flex-direction: column;
            }
            input, button {
                width: 100%;
            }
        }
        /* New Styles */
        .event-success { background-color: #d4edda; }
        .event-error { background-color: #f8d7da; }
        .card {
            background-color: #f8f9fa;
            border-radius: 10px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 10px 0;
        }
        #wallet-info {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
        #wallet-instructions {
            background-color: #e9f7ef;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Airdrop Contract UI (Polygon Amoy)</h1>
            <div id="wallet-status">
                <button id="connect-wallet">Connect MetaMask</button>
                <div id="wallet-info" style="display: none;">
                    <p id="wallet-address"></p>
                    <p id="connection-status">Connected</p>
                    <button id="disconnect-wallet">Disconnect</button>
                </div>
                <div id="wallet-instructions" class="wallet-instructions" style="display: none;"></div>
            </div>
        </header>
        <nav>
            <button onclick="showSection('home')">Home</button>
            <button onclick="showSection('owner')">Owner's Panel</button>
            <button onclick="showSection('user')">User's Panel</button>
        </nav>
        <div id="home" class="section active">
            <h2>Airdrop Contract Info</h2>
            <div id="contract-info" class="card">
                <p id="contract-address">Contract Address: Not Connected</p>
                <p id="contract-balance">Balance: 0 tokens</p>
                <p id="total-distributed">Total Distributed: 0 tokens</p>
                <p id="contract-status">Status: Unknown</p>
            </div>
        </div>
        <div id="owner" class="section">
            <h2>Owner's Panel</h2>
            <div id="airdrop-management">
                <h3>Airdrop Management</h3>
                <div id="recipients">
                    <div class="recipient-row">
                        <input type="text" placeholder="Address">
                        <input type="number" placeholder="Amount">
                        <button onclick="removeRecipient(this)">-</button>
                    </div>
                </div>
                <button onclick="addRecipient()">+</button>
                <p>Total: <span id="total-amount">0</span></p>
                <button onclick="performAirdrop()">Perform Airdrop</button>
            </div>
            <div class="pause-unpause">
                <h3>Contract Status</h3>
                <p>Status: <span id="contract-status">Unknown</span></p>
                <button onclick="togglePause()">Toggle Pause</button>
            </div>
            <div class="withdraw">
                <h3>Withdraw Tokens</h3>
                <input type="number" id="withdraw-amount" placeholder="Amount">
                <button onclick="withdrawTokens()">Withdraw</button>
            </div>
            <div id="tx-status"></div>
            <table id="owner-events">
                <thead><tr><th>Event</th><th>Details</th><th>Timestamp</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="user" class="section">
            <h2>User's Panel</h2>
            <p>Connect your wallet to use owner features if applicable.</p>
            <table id="user-events">
                <thead><tr><th>Event</th><th>Details</th><th>Timestamp</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="debug"></div>
    </div>
    <script src="https://unpkg.com/web3@1.10.4/dist/web3.min.js"></script>
    <script>
        // Debug logging
        function logDebug(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += `<p>${new Date().toLocaleTimeString()} - ${message}</p>`;
        }

        // Hardcoded contract address and ABI
        const CONTRACT_ADDRESS = "0x71d8cc90b62ee78c3a9374e9a8f0ec46e34e22e5";
        const AirdropABI = [
            {
                "inputs": [{"internalType": "address", "name": "tokenAddress", "type": "address"}], "stateMutability": "nonpayable", "type": "constructor"
            },
            {
                "anonymous": false, "inputs": [{"indexed": false, "internalType": "address", "name": "account", "type": "address"}], "name": "Paused", "type": "event"
            },
            {
                "anonymous": false, "inputs": [{"indexed": false, "internalType": "address[]", "name": "hunters", "type": "address[]"}, {"indexed": false, "internalType": "uint256[]", "name": "amounts", "type": "uint256[]"}], "name": "Success", "type": "event"
            },
            {
                "anonymous": false, "inputs": [{"indexed": false, "internalType": "address", "name": "account", "type": "address"}], "name": "Unpaused", "type": "event"
            },
            {
                "anonymous": false, "inputs": [{"indexed": true, "internalType": "address", "name": "owner", "type": "address"}, {"indexed": true, "internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "Withdrawn", "type": "event"
            },
            {
                "inputs": [{"internalType": "address[]", "name": "hunters", "type": "address[]"}, {"internalType": "uint256[]", "name": "amounts", "type": "uint256[]"}], "name": "airdrop", "outputs": [], "stateMutability": "nonpayable", "type": "function"
            },
            {
                "inputs": [], "name": "getBalance", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [], "name": "owner", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [], "name": "pause", "outputs": [], "stateMutability": "nonpayable", "type": "function"
            },
            {
                "inputs": [], "name": "paused", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [], "name": "token", "outputs": [{"internalType": "contract IERC20", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [], "name": "totalDistributed", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"
            },
            {
                "inputs": [], "name": "unpause", "outputs": [], "stateMutability": "nonpayable", "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "_amount", "type": "uint256"}], "name": "withdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function"
            }
        ];

        let web3, contract, userAddress, contractBalance = 0, isPaused = false;

        // Wallet Connection
        const connectWalletBtn = document.getElementById("connect-wallet");
        const disconnectWalletBtn = document.getElementById("disconnect-wallet");
        const walletInfo = document.getElementById("wallet-info");
        const walletAddressElement = document.getElementById("wallet-address");
        let currentGasPrice;

        connectWalletBtn.addEventListener("click", async () => {
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                    userAddress = accounts[0];
                    const shortAddress = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                    walletAddressElement.textContent = `Address: ${shortAddress}`;
                    connectWalletBtn.style.display = "none";
                    walletInfo.style.display = "block";
                    await loadContractInfo();
                } catch (error) {
                    console.error("Wallet connection failed:", error);
                }
            } else {
                alert("Please install MetaMask!");
            }
        });

        disconnectWalletBtn.addEventListener("click", () => {
            userAddress = null;
            connectWalletBtn.style.display = "block";
            walletInfo.style.display = "none";
        });

        // Gas Price Tracking
        async function getCurrentGasPrice() {
            return await web3.eth.getGasPrice();
        }

        // Contract Info Loading
        async function loadContractInfo() {
            contract = new web3.eth.Contract(AirdropABI, CONTRACT_ADDRESS);
            const balance = await contract.methods.getBalance().call();
            const totalDistributed = await contract.methods.totalDistributed().call();
            const paused = await contract.methods.paused().call();
            document.getElementById("contract-address").textContent = `Contract Address: ${CONTRACT_ADDRESS}`;
            document.getElementById("contract-balance").textContent = `Balance: ${balance} tokens`;
            document.getElementById("total-distributed").textContent = `Total Distributed: ${totalDistributed} tokens`;
            document.getElementById("contract-status").textContent = `Status: ${paused ? "Paused" : "Active"}`;
            contractBalance = balance;
            isPaused = paused;
        }

        // Section Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // Airdrop Management
        function addRecipient() {
            const row = document.createElement('div');
            row.className = 'recipient-row';
            row.innerHTML = `
                <input type="text" placeholder="Address">
                <input type="number" placeholder="Amount">
                <button onclick="removeRecipient(this)">-</button>
            `;
            document.getElementById('recipients').appendChild(row);
            updateTotal();
        }

        function removeRecipient(button) {
            button.parentElement.remove();
            updateTotal();
        }

        function updateTotal() {
            const amounts = Array.from(document.querySelectorAll('#recipients input[type="number"]'))
                .map(input => parseFloat(input.value) || 0);
            const total = amounts.reduce((sum, val) => sum + val, 0);
            document.getElementById('total-amount').textContent = total;
        }

        async function performAirdrop() {
            if (!contract) return alert('Connect to contract first!');
            const hunters = Array.from(document.querySelectorAll('#recipients input[type="text"]')).map(input => input.value);
            const amounts = Array.from(document.querySelectorAll('#recipients input[type="number"]')).map(input => input.value);
            const total = parseFloat(document.getElementById('total-amount').textContent);
            if (total > parseFloat(contractBalance)) return alert('Total exceeds contract balance!');
            if (hunters.some(h => !web3.utils.isAddress(h))) return alert('Invalid address detected!');
            try {
                document.getElementById('tx-status').textContent = 'Pending...';
                const tx = await contract.methods.airdrop(hunters, amounts).send({ from: userAddress, gasPrice: await getCurrentGasPrice() });
                document.getElementById('tx-status').innerHTML = `Success! Tx: <a href="https://amoy.polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a> at ${new Date().toLocaleString()}`;
                logDebug("Airdrop successful: " + tx.transactionHash);
                await loadContractInfo();
            } catch (error) {
                document.getElementById('tx-status').textContent = 'Failed: ' + error.message;
                logDebug("Airdrop error: " + error.message);
            }
        }

        // Pause/Unpause
        async function togglePause() {
            if (!contract) return alert('Connect to contract first!');
            try {
                document.getElementById('tx-status').textContent = 'Pending...';
                const method = isPaused ? contract.methods.unpause() : contract.methods.pause();
                const tx = await method.send({ from: userAddress, gasPrice: await getCurrentGasPrice() });
                isPaused = !isPaused;
                document.getElementById('contract-status').textContent = isPaused ? 'Paused' : 'Unpaused';
                document.getElementById('tx-status').innerHTML = `Success! Tx: <a href="https://amoy.polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a> at ${new Date().toLocaleString()}`;
                logDebug("Pause toggled: " + (isPaused ? 'Paused' : 'Unpaused'));
                await loadContractInfo();
            } catch (error) {
                document.getElementById('tx-status').textContent = 'Failed: ' + error.message;
                logDebug("Toggle pause error: " + error.message);
            }
        }

        // Withdraw Tokens
        async function withdrawTokens() {
            if (!contract) return alert('Connect to contract first!');
            const amount = document.getElementById('withdraw-amount').value;
            if (!amount || parseFloat(amount) > parseFloat(contractBalance)) return alert('Invalid amount!');
            try {
                document.getElementById('tx-status').textContent = 'Pending...';
                const tx = await contract.methods.withdraw(amount).send({ from: userAddress, gasPrice: await getCurrentGasPrice() });
                document.getElementById('tx-status').innerHTML = `Success! Tx: <a href="https://amoy.polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a> at ${new Date().toLocaleString()}`;
                logDebug("Withdraw successful: " + tx.transactionHash);
                await loadContractInfo();
            } catch (error) {
                document.getElementById('tx-status').textContent = 'Failed: ' + error.message;
                logDebug("Withdraw error: " + error.message);
            }
        }

        // Event Logging
        function addEventToTable(tableId, eventName, details, timestamp, isSuccess) {
            const table = document.getElementById(tableId).querySelector("tbody");
            const row = document.createElement("tr");
            row.className = isSuccess ? "event-success" : "event-error";
            row.innerHTML = `<td>${eventName}</td><td>${details}</td><td>${new Date(timestamp * 1000).toLocaleString()}</td>`;
            table.appendChild(row);
        }

        // Listen for events
        if (contract) {
            contract.events.Success({})
                .on("data", (event) => {
                    const details = `Hunters: ${event.returnValues.hunters.join(", ")}, Amounts: ${event.returnValues.amounts.join(", ")}`;
                    addEventToTable("owner-events", "Success", details, event.blockTimestamp, true);
                    addEventToTable("user-events", "Success", details, event.blockTimestamp, true);
                });

            contract.events.Withdrawn({})
                .on("data", (event) => {
                    const details = `Owner: ${event.returnValues.owner}, Amount: ${event.returnValues.amount}`;
                    addEventToTable("owner-events", "Withdrawn", details, event.blockTimestamp, true);
                });

            contract.events.Paused({})
                .on("data", (event) => {
                    const details = `Paused by: ${event.returnValues.account}`;
                    addEventToTable("owner-events", "Paused", details, event.blockTimestamp, true);
                });

            contract.events.Unpaused({})
                .on("data", (event) => {
                    const details = `Unpaused by: ${event.returnValues.account}`;
                    addEventToTable("owner-events", "Unpaused", details, event.blockTimestamp, true);
                });
        }

        // Initial debug log
        logDebug("Page loaded");
    </script>
</body>
</html>
