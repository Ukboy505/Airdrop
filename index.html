<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airdrop Contract UI</title>
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        header {
            text-align: center;
            padding: 20px;
            background-color: #007bff;
            color: white;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
        }
        header .wallet-status {
            margin-top: 10px;
        }
        header button {
            padding: 12px 24px;
            background-color: #28a745;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 15px;
            font-size: 16px;
            transition: background-color 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        header button:hover {
            background-color: #218838;
        }
        nav {
            margin: 20px 0;
            text-align: center;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
        }
        nav button {
            margin: 0 10px;
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 15px;
            font-size: 16px;
            transition: background-color 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        nav button:hover {
            background-color: #0056b3;
        }
        .section {
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: none;
        }
        .section.active {
            display: block;
        }
        .section h2 {
            color: #007bff;
            margin-bottom: 15px;
        }
        .section h3, .section h4 {
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        input, button {
            padding: 12px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #0056b3;
        }
        .recipient-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .recipient-row input {
            flex: 1;
            margin-right: 10px;
        }
        #tx-status, #error-message {
            margin-top: 15px;
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }
        #error-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .wallet-instructions {
            margin: 10px 0;
            padding: 12px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            text-align: left;
            font-size: 14px;
        }
        .log-tabs {
            display: flex;
            margin-top: 20px;
            background-color: #e9ecef;
            border-radius: 5px 5px 0 0;
        }
        .log-tab {
            padding: 12px 24px;
            background-color: #ddd;
            cursor: pointer;
            border-radius: 15px 15px 0 0;
            margin-right: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .log-tab.active {
            background-color: #007bff;
            color: white;
        }
        .log-tab:hover {
            background-color: #ccc;
        }
        .log-content {
            padding: 15px;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 0 5px 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .log-content.active, .log-content.error {
            display: block;
        }
        .log-content.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        @media (max-width: 600px) {
            .recipient-row {
                flex-direction: column;
            }
            input, button {
                width: 100%;
            }
            nav button, .log-tab {
                margin: 5px 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Airdrop Contract UI (Polygon Amoy)</h1>
            <div class="wallet-status" id="wallet-status">
                <button id="connect-disconnect">Connect MetaMask</button>
                <div id="wallet-instructions" class="wallet-instructions" style="display: none;"></div>
                <div id="wallet-status-text" style="display: none; margin-top: 10px;"></div>
            </div>
        </header>
        <nav>
            <button onclick="showSection('home')">Home</button>
            <button onclick="showSection('owner')">Owner's Panel</button>
            <button onclick="showSection('user')">User's Panel</button>
        </nav>
        <div id="home" class="section active">
            <h2>Airdrop Contract Information</h2>
            <p>Contract Address: <span id="hardcoded-address">Not Connected</span></p>
            <div id="contract-info"></div>
            <div id="error-message"></div>
        </div>
        <div id="owner" class="section">
            <h2>Owner's Panel</h2>
            <div id="airdrop-management">
                <h3>Airdrop Management</h3>
                <h4>Manual Input</h4>
                <div id="recipients">
                    <div class="recipient-row">
                        <input type="text" placeholder="Address">
                        <input type="number" placeholder="Amount (Tokens, e.g., 1 for 1 wei)" step="0.1">
                        <button onclick="removeRecipient(this)">Remove</button>
                    </div>
                </div>
                <button onclick="addRecipient()">Add Recipient</button>
                <p>Total: <span id="total-amount">0</span> Tokens</p>
                <button onclick="performAirdrop()">Perform Airdrop</button>
                <h4>Batch Input (Comma-Separated)</h4>
                <input type="text" id="batch-input" placeholder="Address1,Amount1,Address2,Amount2,...">
                <button onclick="performBatchAirdrop()">Airdrop from Batch</button>
                <h4>CSV Upload</h4>
                <input type="file" id="csv-upload" accept=".csv" onchange="processCSV(this.files[0])">
                <button onclick="performCSVAirdrop()">Airdrop from CSV</button>
                <button onclick="removeCSV()">Remove CSV</button>
            </div>
            <div class="pause-unpause">
                <h3>Contract Status</h3>
                <p>Status: <span id="contract-status">Unknown</span></p>
                <button onclick="togglePause()">Toggle Pause</button>
            </div>
            <div class="withdraw">
                <h3>Withdraw Tokens</h3>
                <input type="number" id="withdraw-amount" placeholder="Amount (Tokens, e.g., 1 for 1 wei)" step="0.1">
                <button onclick="withdrawTokens()">Withdraw</button>
            </div>
            <div id="tx-status"></div>
            <div id="error-message" class="error"></div>
        </div>
        <div id="user" class="section">
            <h2>User's Panel</h2>
            <input type="text" id="check-address" placeholder="Enter address (leave blank for connected wallet)">
            <button onclick="checkBalance()">Check Balance</button>
            <div id="balance-result"></div>
            <h3>Transfer Tokens</h3>
            <input type="text" id="transfer-to" placeholder="Recipient Address">
            <input type="number" id="transfer-amount" placeholder="Amount (Tokens, e.g., 1 for 1 wei)" step="0.1">
            <button onclick="transferTokens()">Transfer</button>
            <div id="error-message" class="error"></div>
        </div>
        <div class="log-tabs">
            <div class="log-tab active" onclick="showLogTab('admin-logs')">Admin Logs</div>
            <div class="log-tab" onclick="showLogTab('user-logs')">User Logs</div>
        </div>
        <div id="admin-logs" class="log-content active"></div>
        <div id="user-logs" class="log-content"></div>
    </div>
    <script src="https://unpkg.com/web3@1.10.4/dist/web3.min.js"></script>
    <script>
        function logAdmin(message) {
            const logDiv = document.getElementById('admin-logs');
            logDiv.innerHTML += `<table><tr><th>Time</th><th>Event</th><th>Details</th></tr><tr class="${message.includes('Error') || message.includes('failed') ? 'error' : 'active'}"><td>${new Date().toLocaleTimeString()}</td><td>${message.split(':')[0]}</td><td>${message.split(':').slice(1).join(':')}</td></tr></table>`;
        }

        function logUser(message) {
            const logDiv = document.getElementById('user-logs');
            logDiv.innerHTML += `<table><tr><th>Time</th><th>Event</th><th>Details</th></tr><tr class="${message.includes('Error') || message.includes('failed') ? 'error' : 'active'}"><td>${new Date().toLocaleTimeString()}</td><td>${message.split(':')[0]}</td><td>${message.split(':').slice(1).join(':')}</td></tr></table>`;
        }

        function showLogTab(tabId) {
            document.querySelectorAll('.log-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.log-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`.log-tab[onclick="showLogTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function showError(section, message) {
            const errorDiv = document.getElementById('error-message') || document.querySelector(`#${section} #error-message`);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.add('error');
                setTimeout(() => errorDiv.classList.remove('error'), 5000);
            }
            if (section === 'owner' || section === 'home') {
                logAdmin(`Error in ${section}: ${message}`);
            } else {
                logUser(`Error in ${section}: ${message}`);
            }
        }

        const CONTRACT_ADDRESS = "0x71d8cc90b62ee78c3a9374e9a8f0ec46e34e22e5";
        const TOKEN_ADDRESS = "0x9a15aca3b949b057ff7c99df82675a4e3f4b553d";

        let web3, contract, tokenContract, userAddress, contractBalance = '0', isPaused = false, tokenSymbol = '';

        async function getGasPrice() {
            try {
                return await web3.eth.getGasPrice();
            } catch (error) {
                logAdmin("Error fetching gas price: " + error.message);
                return web3.utils.toWei('20', 'gwei');
            }
        }

        document.getElementById('connect-disconnect').addEventListener('click', async () => {
            if (userAddress) {
                userAddress = null;
                contract = null;
                tokenContract = null;
                document.getElementById('wallet-status').innerHTML = `<button id="connect-disconnect">Connect MetaMask</button><div id="wallet-instructions" class="wallet-instructions" style="display: none;"></div>`;
                document.getElementById('wallet-status-text').style.display = 'none';
                document.getElementById('hardcoded-address').textContent = 'Not Connected';
                document.getElementById('contract-info').innerHTML = '';
                document.getElementById('contract-status').textContent = 'Unknown';
                document.getElementById('tx-status').textContent = '';
                document.getElementById('balance-result').innerHTML = '';
                document.getElementById('admin-logs').innerHTML = '';
                document.getElementById('user-logs').innerHTML = '';
                logAdmin("Wallet disconnected");
                document.getElementById('connect-disconnect').style.backgroundColor = '#28a745';
                header.style.backgroundColor = '#007bff';
                document.getElementById('connect-disconnect').addEventListener('click', connectWalletHandler, { once: true });
                return;
            }

            logAdmin("Connecting wallet...");
            const isMobile = /mobile|android|iphone|ipad/.test(navigator.userAgent.toLowerCase());
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const accounts = await web3.eth.getAccounts();
                    userAddress = accounts[0];
                    const chainId = await web3.eth.getChainId();
                    if (chainId !== 80002) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x13882' }]
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x13882',
                                        chainName: 'Polygon Amoy',
                                        rpcUrls: ['https://rpc-amoy.polygon.technology/'],
                                        nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                        blockExplorerUrls: ['https://amoy.polygonscan.com/']
                                    }]
                                });
                            } else {
                                throw switchError;
                            }
                        }
                    }
                    contract = new web3.eth.Contract([
                        {"inputs":[{"internalType":"address","name":"tokenAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
                        {"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},
                        {"anonymous":false,"inputs":[{"indexed":false,"internalType":"address[]","name":"hunters","type":"address[]"},{"indexed":false,"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"name":"Success","type":"event"},
                        {"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},
                        {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Withdrawn","type":"event"},
                        {"inputs":[{"internalType":"address[]","name":"hunters","type":"address[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"name":"airdrop","outputs":[],"stateMutability":"nonpayable","type":"function"},
                        {"inputs":[],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                        {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
                        {"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},
                        {"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
                        {"inputs":[],"name":"token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
                        {"inputs":[],"name":"totalDistributed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                        {"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},
                        {"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}
                    ], CONTRACT_ADDRESS);
                    tokenContract = new web3.eth.Contract([
                        "function name() view returns (string)",
                        "function symbol() view returns (string)",
                        "function balanceOf(address) view returns (uint256)",
                        "function decimals() view returns (uint8)",
                        "function transfer(address to, uint256 value) returns (bool)",
                        "function transferFrom(address from, address to, uint256 value) returns (bool)",
                        "anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"
                    ], TOKEN_ADDRESS);
                    const [name, symbol, balance, total, paused] = await Promise.all([
                        tokenContract.methods.name().call(),
                        tokenContract.methods.symbol().call(),
                        contract.methods.getBalance().call(),
                        contract.methods.totalDistributed().call(),
                        contract.methods.paused().call()
                    ]);
                    contractBalance = web3.utils.fromWei(balance, 'wei');
                    isPaused = paused;
                    tokenSymbol = symbol;
                    document.getElementById('wallet-status').innerHTML = `<button id="connect-disconnect" style="background-color: #007bff">Disconnect</button><div id="wallet-instructions" class="wallet-instructions" style="display: none;"></div>`;
                    document.getElementById('wallet-status-text').textContent = 'Wallet Connected';
                    document.getElementById('wallet-status-text').style.display = 'block';
                    document.getElementById('wallet-status-text').style.color = '#007bff';
                    document.getElementById('connected-address').textContent = `Connected Address: ${userAddress}`;
                    document.getElementById('connected-address').style.display = 'block';
                    document.getElementById('hardcoded-address').textContent = CONTRACT_ADDRESS;
                    document.getElementById('contract-info').innerHTML = `<p>Token Name: ${name}</p><p>Token Symbol: ${symbol}</p><p>Contract Balance: ${contractBalance} ${symbol}</p><p>Total Distributed: ${web3.utils.fromWei(total, 'wei')} ${symbol}</p><p>Contract Status: ${paused ? 'Paused' : 'Unpaused'}</p>`;
                    document.getElementById('contract-status').textContent = paused ? 'Paused' : 'Unpaused';
                    document.getElementById('wallet-instructions').style.display = 'none';
                    header.style.backgroundColor = '#007bff';
                    logAdmin("Wallet connected and contracts loaded: " + CONTRACT_ADDRESS);
                    contract.events.Success({ fromBlock: 'latest' }).on('data', (event) => logAdmin(`Airdrop Success: ${event.returnValues.hunters.length} recipients`)).on('error', (error) => logAdmin("Success event error: " + error.message));
                    contract.events.Paused({ fromBlock: 'latest' }).on('data', (event) => logAdmin(`Contract Paused by ${event.returnValues.account}`)).on('error', (error) => logAdmin("Paused event error: " + error.message));
                    contract.events.Unpaused({ fromBlock: 'latest' }).on('data', (event) => logAdmin(`Contract Unpaused by ${event.returnValues.account}`)).on('error', (error) => logAdmin("Unpaused event error: " + error.message));
                    contract.events.Withdrawn({ fromBlock: 'latest' }).on('data', (event) => logAdmin(`Withdrawn ${web3.utils.fromWei(event.returnValues.amount, 'wei')} by ${event.returnValues.owner}`)).on('error', (error) => logAdmin("Withdrawn event error: " + error.message));
                    tokenContract.events.Transfer({ filter: { from: userAddress }, fromBlock: 'latest' }).on('data', (event) => {
                        logUser(`Transfer: ${web3.utils.fromWei(event.returnValues.value, 'wei')} ${tokenSymbol} from ${event.returnValues.from} to ${event.returnValues.to}`);
                    }).on('error', (error) => logUser("Transfer event error: " + error.message));
                    document.getElementById('connect-disconnect').addEventListener('click', connectWalletHandler, { once: true });
                } catch (error) {
                    logAdmin("Connection error: " + error.message);
                    showError('header', "Failed to connect wallet: " + error.message);
                }
            } else if (isMobile) {
                const currentUrl = window.location.href;
                window.location.href = `metamask://dapp/${currentUrl}`;
                setTimeout(() => {
                    if (!window.ethereum) {
                        showWalletInstructions(isMobile, currentUrl);
                    }
                }, 2000);
            } else {
                showWalletInstructions(isMobile);
            }
        });

        function connectWalletHandler() {
            document.getElementById('connect-disconnect').click();
        }

        function showWalletInstructions(isMobile, url = window.location.href) {
            const instructions = document.getElementById('wallet-instructions');
            instructions.style.display = 'block';
            instructions.innerHTML = isMobile 
                ? `<p>MetaMask not detected. Open this in the MetaMask app:</p><ol><li>Install MetaMask from App Store/Google Play</li><li>Tap browser icon</li><li>Paste: <strong>${url}</strong></li></ol>`
                : `<p>Please install MetaMask from <a href="https://metamask.io" target="_blank">metamask.io</a>.</p>`;
            logAdmin("Showing wallet instructions");
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            logAdmin("Showing section: " + sectionId);
        }

        function addRecipient() {
            try {
                const row = document.createElement('div');
                row.className = 'recipient-row';
                row.innerHTML = `<input type="text" placeholder="Address"><input type="number" placeholder="Amount (Tokens, e.g., 1 for 1 wei)" step="0.1"><button onclick="removeRecipient(this)">Remove</button>`;
                document.getElementById('recipients').appendChild(row);
                updateTotal();
                document.querySelectorAll('#recipients input[type="number"]').forEach(input => {
                    input.addEventListener('input', updateTotal);
                });
            } catch (error) {
                showError('owner', "Error adding recipient: " + error.message);
                logAdmin("Error adding recipient: " + error.message);
            }
        }

        function removeRecipient(button) {
            try {
                button.parentElement.remove();
                updateTotal();
            } catch (error) {
                showError('owner', "Error removing recipient: " + error.message);
                logAdmin("Error removing recipient: " + error.message);
            }
        }

        function updateTotal() {
            try {
                const amounts = Array.from(document.querySelectorAll('#recipients input[type="number"]'))
                    .map(input => parseFloat(input.value) || 0);
                const total = amounts.reduce((sum, val) => sum + val, 0);
                document.getElementById('total-amount').textContent = total.toFixed(2);
            } catch (error) {
                showError('owner', "Error calculating total: " + error.message);
                logAdmin("Error calculating total: " + error.message);
            }
        }

        async function performAirdrop() {
            if (!contract) return showError('owner', 'Please connect your wallet and contract first!');
            try {
                const hunters = Array.from(document.querySelectorAll('#recipients input[type="text"]')).map(input => input.value.trim());
                const amounts = Array.from(document.querySelectorAll('#recipients input[type="number"]')).map(input => {
                    const value = parseFloat(input.value) || 0;
                    if (isNaN(value) || value <= 0) throw new Error(`Invalid amount: ${input.value}`);
                    return web3.utils.toWei(value.toString(), 'wei');
                });
                if (hunters.length !== amounts.length) throw new Error('Mismatch between addresses and amounts');
                if (hunters.some(h => !web3.utils.isAddress(h))) throw new Error('One or more addresses are invalid');
                const total = parseFloat(document.getElementById('total-amount').textContent);
                if (total > parseFloat(contractBalance)) throw new Error('Total exceeds contract balance');
                const gasPrice = await getGasPrice();
                document.getElementById('tx-status').textContent = 'Pending...';
                const tx = await contract.methods.airdrop(hunters, amounts).send({ from: userAddress, gasPrice });
                document.getElementById('tx-status').innerHTML = `Success! Tx: <a href="https://amoy.polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a> at ${new Date().toLocaleString()}`;
                logAdmin("Airdrop successful: " + tx.transactionHash);
                updateContractInfo();
            } catch (error) {
                document.getElementById('tx-status').textContent = '';
                showError('owner', "Airdrop failed: " + error.message);
                logAdmin("Airdrop error: " + error.message);
            }
        }

        async function processCSV(file) {
            if (!file) return showError('owner', 'Please select a CSV file');
            try {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                    const recipientsDiv = document.getElementById('recipients');
                    recipientsDiv.innerHTML = '';
                    lines.forEach(line => {
                        const [address, amount] = line.split(',').map(item => item.trim());
                        if (address && amount && web3.utils.isAddress(address) && !isNaN(parseFloat(amount)) && parseFloat(amount) > 0) {
                            const row = document.createElement('div');
                            row.className = 'recipient-row';
                            row.innerHTML = `<input type="text" value="${address}" placeholder="Address"><input type="number" value="${amount}" placeholder="Amount (Tokens, e.g., 1 for 1 wei)" step="0.1"><button onclick="removeRecipient(this)">Remove</button>`;
                            recipientsDiv.appendChild(row);
                        } else {
                            throw new Error(`Invalid CSV line: ${line}`);
                        }
                    });
                    updateTotal();
                    logAdmin("CSV processed with " + lines.length + " entries");
                };
                reader.readAsText(file);
            } catch (error) {
                showError('owner', "CSV processing error: " + error.message);
                logAdmin("CSV processing error: " + error.message);
            }
        }

        async function performCSVAirdrop() {
            performAirdrop();
        }

        async function performBatchAirdrop() {
            if (!contract) return showError('owner', 'Please connect your wallet and contract first!');
            try {
                const batchInput = document.getElementById('batch-input').value.trim();
                const pairs = batchInput.split(',').map(item => item.trim()).filter(item => item);
                if (pairs.length % 2 !== 0) throw new Error('Invalid batch input format. Use: Address1,Amount1,Address2,Amount2,...');
                
                const hunters = [];
                const amounts = [];
                for (let i = 0; i < pairs.length; i += 2) {
                    const address = pairs[i];
                    const amount = parseFloat(pairs[i + 1]) || 0;
                    if (!web3.utils.isAddress(address)) throw new Error(`Invalid address: ${address}`);
                    if (amount <= 0) throw new Error(`Invalid amount: ${amount}`);
                    hunters.push(address);
                    amounts.push(web3.utils.toWei(amount.toString(), 'wei'));
                }

                const total = hunters.reduce((sum, _, i) => sum + parseFloat(web3.utils.fromWei(amounts[i], 'wei')), 0);
                if (total > parseFloat(contractBalance)) throw new Error('Total exceeds contract balance');
                const gasPrice = await getGasPrice();
                document.getElementById('tx-status').textContent = 'Pending...';
                const tx = await contract.methods.airdrop(hunters, amounts).send({ from: userAddress, gasPrice });
                document.getElementById('tx-status').innerHTML = `Success! Tx: <a href="https://amoy.polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a> at ${new Date().toLocaleString()}`;
                logAdmin("Batch airdrop successful: " + tx.transactionHash);
                updateContractInfo();
            } catch (error) {
                document.getElementById('tx-status').textContent = '';
                showError('owner', "Batch airdrop failed: " + error.message);
                logAdmin("Batch airdrop error: " + error.message);
            }
        }

        async function togglePause() {
            if (!contract) return showError('owner', 'Please connect your wallet and contract first!');
            try {
                document.getElementById('tx-status').textContent = 'Pending...';
                const method = isPaused ? contract.methods.unpause() : contract.methods.pause();
                const gasPrice = await getGasPrice();
                const tx = await method.send({ from: userAddress, gasPrice });
                isPaused = !isPaused;
                document.getElementById('contract-status').textContent = isPaused ? 'Paused' : 'Unpaused';
                document.getElementById('tx-status').innerHTML = `Success! Tx: <a href="https://amoy.polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a> at ${new Date().toLocaleString()}`;
                logAdmin("Pause toggled: " + (isPaused ? 'Paused' : 'Unpaused'));
                updateContractInfo();
            } catch (error) {
                document.getElementById('tx-status').textContent = '';
                showError('owner', "Toggle pause failed: " + error.message);
                logAdmin("Toggle pause error: " + error.message);
            }
        }

        async function withdrawTokens() {
            if (!contract) return showError('owner', 'Please connect your wallet and contract first!');
            const amount = document.getElementById('withdraw-amount').value;
            if (!amount || parseFloat(amount) <= 0) return showError('owner', 'Invalid amount!');
            try {
                document.getElementById('tx-status').textContent = 'Pending...';
                const gasPrice = await getGasPrice();
                const tx = await contract.methods.withdraw(web3.utils.toWei(amount.toString(), 'wei')).send({ from: userAddress, gasPrice });
                document.getElementById('tx-status').innerHTML = `Success! Tx: <a href="https://amoy.polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a> at ${new Date().toLocaleString()}`;
                logAdmin("Withdraw successful: " + tx.transactionHash);
                updateContractInfo();
            } catch (error) {
                document.getElementById('tx-status').textContent = '';
                showError('owner', "Withdraw failed: " + error.message);
                logAdmin("Withdraw error: " + error.message);
            }
        }

        async function checkBalance() {
            if (!tokenContract) return showError('user', 'Please connect your wallet and contract first!');
            const addr = document.getElementById('check-address').value.trim() || userAddress;
            if (!web3.utils.isAddress(addr)) return showError('user', 'Invalid address!');
            try {
                const decimals = await tokenContract.methods.decimals().call();
                const bal = await tokenContract.methods.balanceOf(addr).call();
                const formattedBalance = (bal / Math.pow(10, decimals)).toFixed(decimals);
                document.getElementById('balance-result').innerHTML = `Balance: ${formattedBalance} ${tokenSymbol} (Decimals: ${decimals})`;
                logUser("Balance checked for: " + addr + " - " + formattedBalance + " " + tokenSymbol);
            } catch (error) {
                showError('user', "Balance check failed: " + error.message);
                logUser("Balance check error: " + error.message);
            }
        }

        async function transferTokens() {
            if (!tokenContract) return showError('user', 'Please connect your wallet and contract first!');
            const toAddress = document.getElementById('transfer-to').value.trim();
            const amount = document.getElementById('transfer-amount').value;
            if (!web3.utils.isAddress(toAddress)) return showError('user', 'Invalid recipient address!');
            if (!amount || parseFloat(amount) <= 0) return showError('user', 'Invalid amount!');
            try {
                const decimals = await tokenContract.methods.decimals().call();
                const value = Math.floor(parseFloat(amount) * Math.pow(10, decimals));
                const gasPrice = await getGasPrice();
                const tx = await tokenContract.methods.transfer(toAddress, value.toString()).send({ from: userAddress, gasPrice });
                logUser(`Transfer successful: ${amount} ${tokenSymbol} to ${toAddress} - Tx: <a href="https://amoy.polygonscan.com/tx/${tx.transactionHash}" target="_blank">${tx.transactionHash}</a>`);
                checkBalance();
            } catch (error) {
                showError('user', "Transfer failed: " + error.message);
                logUser("Transfer error: " + error.message);
            }
        }

        async function updateContractInfo() {
            if (contract) {
                try {
                    const [balance, total, paused] = await Promise.all([
                        contract.methods.getBalance().call(),
                        contract.methods.totalDistributed().call(),
                        contract.methods.paused().call()
                    ]);
                    contractBalance = web3.utils.fromWei(balance, 'wei');
                    isPaused = paused;
                    const name = await tokenContract.methods.name().call();
                    const symbol = await tokenContract.methods.symbol().call();
                    document.getElementById('contract-info').innerHTML = `<p>Token Name: ${name}</p><p>Token Symbol: ${symbol}</p><p>Contract Balance: ${contractBalance} ${symbol}</p><p>Total Distributed: ${web3.utils.fromWei(total, 'wei')} ${symbol}</p><p>Contract Status: ${paused ? 'Paused' : 'Unpaused'}</p>`;
                    document.getElementById('contract-status').textContent = paused ? 'Paused' : 'Unpaused';
                } catch (error) {
                    showError('home', "Error updating contract info: " + error.message);
                    logAdmin("Error updating contract info: " + error.message);
                }
            }
        }

        function removeCSV() {
            document.getElementById('recipients').innerHTML = `<div class="recipient-row"><input type="text" placeholder="Address"><input type="number" placeholder="Amount (Tokens, e.g., 1 for 1 wei)" step="0.1"><button onclick="removeRecipient(this)">Remove</button></div>`;
            updateTotal();
            logAdmin("CSV removed");
        };

        logAdmin("Page loaded");
        document.getElementById('connect-disconnect').addEventListener('click', connectWalletHandler, { once: true });
        document.querySelectorAll('#recipients input[type="number"]').forEach(input => {
            input.addEventListener('input', updateTotal);
        });
    </script>
</body>
</html>
